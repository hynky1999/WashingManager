@namespace PrackyASusarny.Shared.Components.GenericForm
@inject IServiceProvider ServiceProvider
@typeparam TModel

@if (_fields != null) {
    <Form Loading="@Loading" Model="@Model" OnFinish="@OnFinish">
        @foreach (var field in _fields) {
            @if (FieldTemplate != null) {
                @FieldTemplate(field)
            } else {
                <FormItem Label="@field.DisplayName">
                    @field.FieldFragment
                    <Paragraph>@field.Description</Paragraph>
                </FormItem>
            }
        }
        <Button Type="@ButtonType.Primary" HtmlType="submit">Submit</Button>
    </Form>
}

@code{
    private List<GenericInput<TModel>>? _fields;

    [Parameter]
    public TModel? Model { get; set; }

    [Parameter]
    public EventCallback<TModel> ModelChanged { get; set; }

    [Parameter]
    public bool Loading { get; set; } = false;

    [Parameter]
    public RenderFragment<GenericInput<TModel>>? FieldTemplate { get; set; }

    [Parameter]
    public EventCallback OnFinish { get; set; }

    protected override void OnParametersSet() {
        base.OnParametersSet();

        if (_fields != null) {
            foreach (var field in _fields) {
                field.ValueChanged = EventCallback.Factory.Create(this, OnValueChanged);
            }
        }

        if (Model != null) {
            _fields = GenericInput<TModel>.Create(Model, ServiceProvider);
            foreach (var field in _fields) {
                field.ValueChanged = EventCallback.Empty;
            }
        } else {
            _fields = null;
        }
    }

    private void OnValueChanged() {
        ModelChanged.InvokeAsync(Model);
    }


}