@using System.Collections.Concurrent
@using System.Linq.Expressions
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory;
@typeparam T where T: class
<CascadingValue Value="@OnFilterChanged" Name="OnFilterChanged">
    <CascadingValue Value="@RegisterFilter" Name="RegisterFilter">
        @ChildContent
    </CascadingValue>
</CascadingValue>

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }
    
    [Parameter, EditorRequired]
    public Func<ApplicationDbContext, DbSet<T>> GetDbSet { get; set; }

    [Parameter]
    public EventCallback<List<T>> OnItemsChanged { get; set; }

    ConcurrentBag<Func<IQueryable<T>, IQueryable<T>>> Filters { get; } = new();

    public void RegisterFilter(Func<IQueryable<T>, IQueryable<T>> filter)
    {
        Filters.Add(filter);
    }

    public async Task OnFilterChanged()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();
        var query = GetDbSet(context).AsQueryable();
        foreach (var filter in Filters)
        {
            query = filter(query);
        }
        await OnItemsChanged.InvokeAsync(query.ToList());
    }
    
    
}